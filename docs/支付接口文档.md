# 收钱吧支付接口文档

## 概述

本文档描述了任务交易平台集成收钱吧支付系统的完整接口实现，包括预支付、支付回调、退款、转账等功能。

## 接口列表

### 1. 预支付接口

**接口地址：** `POST /api/v1/pay/prepay`

**功能说明：** 创建预支付订单，生成支付链接或二维码

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| task_id | uint64 | 是 | 任务ID |
| order_type | string | 是 | 订单类型：task_publish/task_take |
| amount | float64 | 是 | 支付金额 |
| return_url | string | 否 | 支付成功后跳转地址 |
| client_ip | string | 否 | 客户端IP |
| remark | string | 否 | 备注信息 |

**请求示例：**

```json
{
  "task_id": 123,
  "order_type": "task_publish",
  "amount": 100.00,
  "return_url": "https://example.com/pay/success",
  "remark": "任务发布费用"
}
```

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "order_no": "SQ20240101120000123456",
    "trade_no": "SQ_TRADE_123456",
    "pay_url": "https://pay.shouqianba.com/pay/xxx",
    "qrcode": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
    "amount": 100.00,
    "expire_time": 1704070800
  }
}
```

### 2. 支付查询接口

**接口地址：** `GET /api/v1/pay/query`

**功能说明：** 查询订单支付状态

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| order_no | string | 是 | 订单号 |

**请求示例：**

```
GET /api/v1/pay/query?order_no=SQ20240101120000123456
```

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "order_no": "SQ20240101120000123456",
    "trade_no": "SQ_TRADE_123456",
    "user_id": 123,
    "task_id": 456,
    "trade_type": "task_publish",
    "amount": 100.00,
    "status": "paid",
    "pay_time": "2024-01-01T12:00:00Z",
    "pay_method": "ALIPAY",
    "transaction_id": "2024010122001234567890123456",
    "created_at": "2024-01-01T12:00:00Z",
    "updated_at": "2024-01-01T12:00:00Z"
  }
}
```

### 3. 退款接口

**接口地址：** `POST /api/v1/pay/refund`

**功能说明：** 申请订单退款

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| order_no | string | 是 | 原订单号 |
| amount | float64 | 是 | 退款金额 |
| reason | string | 是 | 退款原因 |

**请求示例：**

```json
{
  "order_no": "SQ20240101120000123456",
  "amount": 100.00,
  "reason": "任务取消"
}
```

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "refund_no": "RF20240101120000123456",
    "trade_id": 123,
    "order_no": "SQ20240101120000123456",
    "user_id": 456,
    "task_id": 789,
    "amount": 100.00,
    "reason": "任务取消",
    "status": "pending",
    "refund_time": null,
    "created_at": "2024-01-01T12:00:00Z",
    "updated_at": "2024-01-01T12:00:00Z"
  }
}
```

### 4. 任务结算接口

**接口地址：** `POST /api/v1/pay/settlement`

**功能说明：** 完成任务结算，转账给接取方

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| task_id | uint64 | 是 | 任务ID |
| publisher_amount | float64 | 是 | 发布方应得金额 |
| taker_amount | float64 | 是 | 接取方应得金额 |

**请求示例：**

```json
{
  "task_id": 123,
  "publisher_amount": 80.00,
  "taker_amount": 85.00
}
```

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "message": "结算成功"
  }
}
```

### 5. 用户余额接口

**接口地址：** `GET /api/v1/pay/balance`

**功能说明：** 获取用户账户余额信息

**请求参数：** 无

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "user_id": 123,
    "total_income": 1000.00,
    "total_expense": 500.00,
    "available_balance": 500.00,
    "frozen_balance": 0.00
  }
}
```

### 6. 交易记录接口

**接口地址：** `GET /api/v1/pay/transactions`

**功能说明：** 获取用户交易记录列表

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | int | 否 | 页码，默认1 |
| page_size | int | 否 | 页大小，默认20 |
| trade_type | string | 否 | 交易类型 |
| status | string | 否 | 交易状态 |

**请求示例：**

```
GET /api/v1/pay/transactions?page=1&page_size=20&trade_type=task_publish
```

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "order_no": "SQ20240101120000123456",
        "trade_no": "SQ_TRADE_123456",
        "user_id": 123,
        "task_id": 456,
        "trade_type": "task_publish",
        "amount": 100.00,
        "status": "paid",
        "pay_time": "2024-01-01T12:00:00Z",
        "pay_method": "ALIPAY",
        "created_at": "2024-01-01T12:00:00Z"
      }
    ],
    "total": 1,
    "page": 1,
    "page_size": 20
  }
}
```

## 回调接口

### 1. 支付回调

**接口地址：** `POST /api/v1/pay/callback`

**功能说明：** 接收收钱吧支付结果回调

**处理流程：**
1. 验证回调签名
2. 解析回调数据
3. 更新本地交易状态
4. 触发后续业务逻辑

### 2. 退款回调

**接口地址：** `POST /api/v1/pay/refund_callback`

**功能说明：** 接收收钱吧退款结果回调

### 3. 转账回调

**接口地址：** `POST /api/v1/pay/transfer_callback`

**功能说明：** 接收收钱吧转账结果回调

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 参数错误 |
| 401 | 未授权 |
| 403 | 权限不足 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

## 业务流程

### 任务发布支付流程

1. 用户创建任务
2. 调用预支付接口，order_type=task_publish
3. 用户完成支付
4. 系统接收支付回调
5. 更新任务状态为待审核
6. 审核通过后任务开放接取

### 任务接取支付流程

1. 用户浏览任务列表
2. 选择任务并申请接取
3. 调用预支付接口，order_type=task_take
4. 用户完成支付
5. 系统接收支付回调
6. 更新任务状态为进行中

### 任务结算流程

1. 接取方完成并提交成果
2. 发布方验收通过
3. 调用结算接口
4. 系统创建转账订单
5. 转账给接取方
6. 更新任务状态为已完成

## 安全机制

### 1. 签名验证

所有回调请求都包含签名参数，系统会验证签名的正确性：

1. 按参数名排序
2. 拼接键值对
3. 添加商户密钥
4. MD5加密并转为大写

### 2. 重复处理防护

使用订单号作为唯一标识，防止重复处理相同的回调请求。

### 3. 金额验证

回调中的金额与本地记录金额进行对比，防止金额篡改。

### 4. 状态检查

检查订单当前状态，避免重复处理已完成或已失败的订单。

## 监控和日志

### 1. 接口监控

- 请求响应时间
- 成功率统计
- 错误分布

### 2. 业务监控

- 支付成功率
- 退款率
- 结算成功率

### 3. 日志记录

所有支付相关操作都记录详细日志，包括：
- 请求参数
- 响应结果
- 错误信息
- 处理时间

## 测试

### 1. 单元测试

```bash
make test-payment
```

### 2. 集成测试

```bash
make test-integration
```

### 3. 性能测试

```bash
make bench
```

## 配置说明

收钱吧相关配置在 `configs/config.yaml` 中：

```yaml
shouqianba:
  app_id: "your-app-id"
  merchant_no: "your-merchant-no"
  secret_key: "your-secret-key"
  api_url: "https://api.shouqianba.com"
  sandbox_url: "https://sandbox.shouqianba.com"
  sandbox: true
  notify_url: "http://localhost:8080/api/v1/pay/callback"
```

## 注意事项

1. **生产环境配置：** 生产环境需要使用真实的收钱吧商户信息
2. **网络安全：** 回调URL必须公网可访问，建议使用HTTPS
3. **超时处理：** 预支付订单设置15分钟过期时间
4. **幂等性：** 所有接口都支持幂等性操作
5. **异常处理：** 完善的错误处理和重试机制